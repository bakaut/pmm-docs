# Миграция схемы БД MindScribe: от JSON к отдельным полям

## Обзор изменений

Выполнена миграция схемы базы данных для разделения JSON поля `content` на отдельные структурированные поля:

### Новые поля в таблице `summary`:
- `summary_text` (TEXT) - краткое саммари основного содержания
- `key_points` (JSONB) - ключевые точки в виде JSON массива
- `main_themes` (JSONB) - основные темы в виде JSON массива  
- `insights` (JSONB) - важные наблюдения в виде JSON массива
- `language` (TEXT) - язык контента (по умолчанию 'ru')

### Файлы изменений:

#### 1. `migrate-3.sql` (НОВЫЙ)
- Добавляет новые колонки
- Мигрирует существующие данные из JSON поля `content`
- Создает индексы для поиска и производительности
- Сохраняет поле `content` для обратной совместимости

#### 2. `index.py` - Обновлен код
- Функции `create_summary()` и `create_enhanced_summary()` теперь заполняют оба формата
- Новая функция `get_structured_summaries_by_role()` для получения структурированных данных
- Обновлен API handler с поддержкой нового формата
- Добавлена обратная совместимость со старым форматом

### API изменения:

#### Новые параметры запроса:
```json
{
  "session_id": "session123",
  "action": "get",
  "summary_type": "L1", 
  "role": "user",
  "structured": true
}
```

#### Новый формат ответа (structured=true):
```json
{
  "session_id": "session123",
  "format": "structured",
  "summaries": [
    {
      "id": "uuid",
      "summary_text": "Краткое описание...",
      "key_points": ["Пункт 1", "Пункт 2"],
      "main_themes": ["Тема 1", "Тема 2"],
      "insights": ["Наблюдение 1", "Наблюдение 2"],
      "language": "ru",
      "created_at": "2024-01-01T00:00:00Z",
      // ... другие поля
    }
  ]
}
```

### Обратная совместимость:
- Поле `content` сохранено и продолжает заполняться
- Старые API вызовы без параметра `structured` работают как прежде
- Существующие данные мигрированы автоматически

### Применение миграции:
```sql
-- Запустить миграцию
psql -d your_database -f migrate-3.sql
```

### Примеры использования:

#### Получение структурированных данных:
```bash
curl -X POST https://your-api/mindscribe \
  -d '{"session_id": "123", "action": "get", "summary_type": "L1", "role": "user", "structured": true}'
```

#### Обработка + получение в новом формате:
```bash
curl -X POST https://your-api/mindscribe \
  -d '{"session_id": "123", "user_id": "user1", "summary_type": "L1", "role": "user", "structured": true}'
```

## Преимущества новой схемы:
1. **Лучшая производительность** - отдельные индексы для каждого поля
2. **Гибкость запросов** - можно искать по конкретным полям
3. **Типизация данных** - JSONB для массивов, TEXT для текста
4. **Обратная совместимость** - старый код продолжает работать
5. **Полнотекстовый поиск** - GIN индекс для поиска по тексту саммари
